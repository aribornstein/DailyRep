<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pull-up Motion Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #0b1020;
      color: #f7f7ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, #28335f, #050814);
      border-radius: 24px;
      padding: 24px 20px 28px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      text-align: center;
    }

    h1 {
      font-size: 1.7rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .status {
      font-size: 0.9rem;
      margin: 8px 0 4px;
      min-height: 1.2em;
    }

    .status.small {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .status-ok {
      color: #8be88b;
    }

    .status-warn {
      color: #ffdf7a;
    }

    .status-err {
      color: #ff7a7a;
    }

    .btn {
      display: inline-block;
      margin: 8px 4px 0;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
    }

    .btn-primary {
      background: #4f88ff;
      color: #fff;
      box-shadow: 0 6px 14px rgba(79, 136, 255, 0.6);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 3px 7px rgba(79, 136, 255, 0.7);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.35);
      color: #fff;
    }

    .btn-secondary:active {
      transform: translateY(1px) scale(0.99);
    }

    .btn-disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .metrics {
      margin-top: 10px;
      font-size: 0.8rem;
      opacity: 0.7;
      line-height: 1.4;
    }

    .hint {
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 14px;
      line-height: 1.4;
      text-align: left;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.82em;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Pull-up Motion Logger</h1>
  <div class="subtitle">Log accelerometer data while you do 5 pull-ups.</div>

  <div id="status" class="status status-warn">Tap <b>Start Logging</b>, then do your reps.</div>
  <div id="statusSub" class="status small"></div>

  <button id="startBtn" class="btn btn-primary">Start Logging</button>
  <button id="stopBtn" class="btn btn-secondary" disabled>Stop Logging</button>
  <button id="downloadBtn" class="btn btn-secondary btn-disabled" disabled>Download CSV</button>

  <div id="metrics" class="metrics"></div>

  <div class="hint">
    <b>Steps:</b><br/>
    1. Tap <b>Start Logging</b> and allow motion permission if asked.<br/>
    2. Put phone in your pocket and do about 5 pull-ups.<br/>
    3. Tap <b>Stop Logging</b>.<br/>
    4. Tap <b>Download CSV</b> and send the file to your computer (AirDrop, email, etc.).<br/><br/>
    CSV columns: <code>time_ms, ax, ay, az, mag_total, net_without_gravity</code>
  </div>
</div>

<script>
  let listening = false;
  let logging = false;
  let motionHandler = null;

  let startTime = null;
  let samples = []; // {t, ax, ay, az, mag, net}

  const statusEl = document.getElementById('status');
  const statusSubEl = document.getElementById('statusSub');
  const metricsEl = document.getElementById('metrics');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  function setStatus(text, type = 'ok', subText = '') {
    statusEl.textContent = text;
    statusEl.className = 'status ' +
      (type === 'ok' ? 'status-ok' :
       type === 'warn' ? 'status-warn' : 'status-err');
    statusSubEl.textContent = subText;
  }

  function computeAccel(event) {
    const acc = event.accelerationIncludingGravity || event.acceleration;
    if (!acc) return null;
    const ax = acc.x || 0;
    const ay = acc.y || 0;
    const az = acc.z || 0;
    const mag = Math.sqrt(ax * ax + ay * ay + az * az);
    const net = Math.abs(mag - 9.81); // approx "extra" beyond gravity
    return { ax, ay, az, mag, net };
  }

  function onMotion(event) {
    if (!listening) return;
    const t = Date.now();
    const relTime = startTime ? t - startTime : 0;

    const accel = computeAccel(event);
    if (!accel) return;

    const { ax, ay, az, mag, net } = accel;

    // live metrics (light throttling)
    if (relTime % 100 < 20) {
      metricsEl.textContent =
        `Samples: ${samples.length}  |  t=${relTime} ms\n` +
        `ax=${ax.toFixed(2)}, ay=${ay.toFixed(2)}, az=${az.toFixed(2)} m/s²\n` +
        `mag=${mag.toFixed(2)} m/s², net≈${net.toFixed(2)} m/s²`;
    }

    if (logging) {
      samples.push({
        t: relTime,
        ax,
        ay,
        az,
        mag,
        net
      });
    }
  }

  function startLogging() {
    if (listening) return;

    samples = [];
    startTime = Date.now();

    motionHandler = onMotion;
    window.addEventListener('devicemotion', motionHandler);
    listening = true;
    logging = true;

    startBtn.disabled = true;
    stopBtn.disabled = false;
    downloadBtn.disabled = true;
    downloadBtn.classList.add('btn-disabled');

    setStatus('Logging…', 'ok', 'Do ~5 pull-ups, then tap Stop Logging.');
  }

  function stopLogging() {
    if (!listening) return;

    window.removeEventListener('devicemotion', motionHandler);
    listening = false;
    logging = false;
    motionHandler = null;

    startBtn.disabled = false;
    stopBtn.disabled = true;
    downloadBtn.disabled = samples.length === 0;
    downloadBtn.classList.toggle('btn-disabled', samples.length === 0);

    setStatus('Logging stopped.', 'warn',
      samples.length + ' samples recorded. Tap Download CSV to export.');
  }

  function samplesToCSV() {
    const header = ['time_ms', 'ax', 'ay', 'az', 'mag_total', 'net_without_gravity'];
    const rows = [header.join(',')];

    for (const s of samples) {
      rows.push([
        s.t,
        s.ax.toFixed(5),
        s.ay.toFixed(5),
        s.az.toFixed(5),
        s.mag.toFixed(5),
        s.net.toFixed(5),
      ].join(','));
    }
    return rows.join('\n');
  }

  function downloadCSV() {
    if (!samples.length) {
      setStatus('No samples to download.', 'err');
      return;
    }
    const csv = samplesToCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g, '-');
    a.href = url;
    a.download = 'pullup_log_' + ts + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    setStatus('CSV download triggered.', 'ok',
      'Use your browser’s download/share options to send it to your computer.');
  }

  async function requestMotionPermissionIfNeeded() {
    const DeviceMotionEventRef = window.DeviceMotionEvent;
    if (DeviceMotionEventRef && typeof DeviceMotionEventRef.requestPermission === 'function') {
      try {
        const response = await DeviceMotionEventRef.requestPermission();
        if (response === 'granted') {
          return true;
        } else {
          setStatus('Motion permission denied.', 'err',
            'Go to Settings > Safari > Motion & Orientation Access and enable it.');
          return false;
        }
      } catch (err) {
        console.error(err);
        setStatus('Unable to request motion permission.', 'err', String(err));
        return false;
      }
    } else {
      if ('DeviceMotionEvent' in window) return true;
      setStatus('Device motion not supported on this browser.', 'err');
      return false;
    }
  }

  startBtn.addEventListener('click', async () => {
    const ok = await requestMotionPermissionIfNeeded();
    if (!ok) return;
    if (!('DeviceMotionEvent' in window)) {
      setStatus('Device motion not supported on this device.', 'err');
      return;
    }
    startLogging();
  });

  stopBtn.addEventListener('click', () => {
    stopLogging();
  });

  downloadBtn.addEventListener('click', () => {
    downloadCSV();
  });

  window.addEventListener('pagehide', stopLogging);
  window.addEventListener('blur', stopLogging);
</script>
</body>
</html>
